# -*- coding: utf-8 -*-
# ì´ íŒŒì¼ì€ UTF-8 ì¸ì½”ë”©ì„ ì‚¬ìš©í•˜ì—¬ í•œê¸€ì´ ê¹¨ì§€ì§€ ì•Šë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤. (ì´ˆì‹¬ììš© ìƒì„¸ ì£¼ì„ ë²„ì „)

"""
============================================================================
ğŸ“š 01b. Memory Agent - ëŒ€í™” ê¸°ë¡ì„ ìœ ì§€í•˜ëŠ” Agent
============================================================================

ì´ ì˜ˆì œëŠ” MemorySaverë¥¼ ì‚¬ìš©í•˜ì—¬ ëŒ€í™” ê¸°ë¡ì„ ì»´í“¨í„° ë©”ëª¨ë¦¬ì— ê¸°ì–µí•˜ê³ ,
'ëŒ€í™”ë°© ID(thread_id)'ë¥¼ ì´ìš©í•´ ê³¼ê±° ëŒ€í™”ë¥¼ ì´ì–´ê°€ëŠ” ë°©ë²•ì„ í•™ìŠµí•©ë‹ˆë‹¤.

ğŸ¯ í•µì‹¬ í•™ìŠµ í¬ì¸íŠ¸:
    1. MemorySaver: ê³¼ê±° ëŒ€í™” ë‚´ìš©ì„ ì €ì¥í•˜ëŠ” 'ê¸°ì–µ ì €ì¥ì†Œ' ì‚¬ìš©ë²•.
    2. thread_id: ì—¬ëŸ¬ ëŒ€í™”ë°©ì„ êµ¬ë¶„í•˜ëŠ” ì•„ì´ë”” ê°œë… ì´í•´.
    3. AIê°€ ì˜ˆì „ ì§ˆë¬¸ì´ë‚˜ ë‚´ ì´ë¦„ì„ ê¸°ì–µí•˜ê²Œ ë§Œë“œëŠ” ë°©ë²•.
"""

# =============================================================================
# ğŸ“¦ í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„í¬íŠ¸
# =============================================================================

import sys                              # ì‹œìŠ¤í…œ í™˜ê²½ ì œì–´
import os                               # í™˜ê²½ë³€ìˆ˜ ì ‘ê·¼
from pathlib import Path                # ê²½ë¡œ ê´€ë¦¬
from typing import Literal              # íŠ¹ì • í…ìŠ¤íŠ¸ íƒ€ì… ì§€ì •

# í”„ë¡œì íŠ¸ ë£¨íŠ¸(ìµœìƒìœ„ í´ë”)ë¥¼ ê²½ë¡œì— ì¶”ê°€í•˜ì—¬ ë‹¤ë¥¸ í´ë”ì˜ ëª¨ë“ˆì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
sys.path.insert(0, str(Path(__file__).parent.parent))

# .env íŒŒì¼ì—ì„œ í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
from dotenv import load_dotenv
load_dotenv()

# LangChain ë©”ì‹œì§€ í˜•ì‹ (ì‚¬ëŒ, ì‹œìŠ¤í…œ ë©”ì‹œì§€)
from langchain_openai import ChatOpenAI # LLM ëª¨ë¸ í´ë˜ìŠ¤
from langchain_core.messages import HumanMessage, SystemMessage
# íŒŒì´ì¬ í•¨ìˆ˜ë¥¼ AIìš© ë„êµ¬ë¡œ ë³€í™˜
from langchain_core.tools import tool

# LangGraphì˜ í•µì‹¬ ìš”ì†Œì™€ ë©”ëª¨ë¦¬(MemorySaver) ëª¨ë“ˆì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
from langgraph.graph import StateGraph, MessagesState, START, END
from langgraph.prebuilt import ToolNode, tools_condition
from langgraph.checkpoint.memory import MemorySaver  # ëŒ€í™” ë‚´ìš©ì„ ë©”ëª¨ë¦¬ì— ì„ì‹œ ì €ì¥í•˜ëŠ” ë„êµ¬

# í”„ë¡œì íŠ¸ ê³µí†µ ìœ í‹¸ë¦¬í‹°
from utils.llm_factory import log_llm_error


# =============================================================================
# ğŸ› ï¸ 1. ë„êµ¬ ì •ì˜í•˜ê¸°
# =============================================================================

@tool # ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ê¸°ì–µí•˜ëŠ” ì²™ í•˜ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.
def remember_user_info(info: str) -> str:
    """
    ì‚¬ìš©ìê°€ ì•Œë ¤ì¤€ ì´ë¦„, ì·¨ë¯¸, ìƒì¼ ë“± ì¤‘ìš”í•œ ì •ë³´ë¥¼ ê¸°ì–µ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í•©ë‹ˆë‹¤.
    """
    # ì‹¤ì œ DBì— ì €ì¥í•˜ëŠ” ëŒ€ì‹ , ì‹¤í–‰ ê²°ê³¼ë¡œ ì„±ê³µ ë©”ì‹œì§€ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.
    return f"ë©”ëª¨ ì™„ë£Œ: '{info}'ë¼ê³  ë§ì”€í•˜ì‹  ê²ƒì„ ì˜ ê¸°ì–µí•´ ë‘ì—ˆìŠµë‹ˆë‹¤!"


@tool # ê°„ë‹¨í•œ ê³„ì‚° ë„êµ¬ì…ë‹ˆë‹¤.
def calculate(expression: str) -> str:
    """ìˆ˜í•™ ê³„ì‚°(ì˜ˆ: 10 + 20)ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤."""
    try:
        allowed = set("0123456789+-*/(). ") # ì•ˆì „í•œ ë¬¸ì í™•ì¸
        if not all(c in allowed for c in expression):
            return "ì˜¤ë¥˜: í—ˆìš©ë˜ì§€ ì•Šì€ ìˆ˜ì‹ì…ë‹ˆë‹¤."
        result = eval(expression)
        return f"ê³„ì‚° ê²°ê³¼: {result}"
    except Exception as e:
        return f"ê³„ì‚° ì˜¤ë¥˜: {e}"


# AIê°€ ì‚¬ìš©í•  ë„êµ¬ë“¤ì„ ëª©ë¡ìœ¼ë¡œ ë¬¶ìŠµë‹ˆë‹¤.
tools = [remember_user_info, calculate]


# =============================================================================
# ğŸ¤– 2. Agent ë…¸ë“œ (ìƒê°í•˜ëŠ” ë‹¨ê³„)
# =============================================================================

def agent_node(state: MessagesState) -> dict:
    """ì§€ê¸ˆê¹Œì§€ì˜ ëŒ€í™”(state)ë¥¼ ë³´ê³  ë‹¤ìŒì— í•  ì¼ì„ ê²°ì •í•©ë‹ˆë‹¤."""
    # 1. AI ëª¨ë¸ì„ ì´ˆê¸°í™”í•˜ê³  ë„êµ¬ë“¤ì„ ì—°ê²°í•©ë‹ˆë‹¤.
    model = ChatOpenAI(
        base_url=os.getenv("OPENAI_API_BASE"),
        api_key=os.getenv("OPENAI_API_KEY"),
        model=os.getenv("OPENAI_MODEL")
    )
    model_with_tools = model.bind_tools(tools, parallel_tool_calls=False)
    
    # 2. AIì—ê²Œ ë¶€ì—¬í•  ì„±ê²©(ê¸°ì–µë ¥ì´ ì¢‹ì€ ë¹„ì„œ)ì„ ì„¤ì •í•©ë‹ˆë‹¤.
    system_message = SystemMessage(content="""ë‹¹ì‹ ì€ ëŒ€í™” ë‚´ìš©ì„ ì•„ì£¼ ì˜ ê¸°ì–µí•˜ëŠ” ì¹œì ˆí•œ ë¹„ì„œì…ë‹ˆë‹¤.
- ì‚¬ìš©ìê°€ ì´ë¦„ì„ ì•Œë ¤ì£¼ê±°ë‚˜ ì •ë³´ë¥¼ ì£¼ë©´ ê¼­ ë‹¤ìŒ ëŒ€í™”ì—ì„œ í™œìš©í•˜ì„¸ìš”.
- ì´ì „ ëŒ€í™” ë¬¸ë§¥ì„ íŒŒì•…í•´ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€ë‹µí•´ ì£¼ì„¸ìš”.
- í•œê¸€ë¡œ ì¹œì ˆíˆ ëŒ€ë‹µí•˜ì„¸ìš”.
""")
    
    # 3. [ì§€ì¹¨] + [ê³¼ê±°ì˜ ëª¨ë“  ëŒ€í™” ê¸°ë¡(state["messages"])]ì„ í•˜ë‚˜ë¡œ í•©ì¹©ë‹ˆë‹¤.
    # state["messages"] ì•ˆì—ëŠ” ë©”ëª¨ë¦¬ ì €ì¥ì†Œì—ì„œ ë¶ˆëŸ¬ì˜¨ ì´ì „ ëŒ€í™”ë“¤ì´ ìë™ìœ¼ë¡œ ë“¤ì–´ìˆìŠµë‹ˆë‹¤.
    messages = [system_message] + state["messages"]
    
    # 4. AIì—ê²Œ ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•˜ê³  ì‘ë‹µì„ ë°›ìŠµë‹ˆë‹¤.
    response = model_with_tools.invoke(messages)
    
    return {"messages": [response]}


# =============================================================================
# ğŸ—„ï¸ 3. ë©”ëª¨ë¦¬ê°€ í¬í•¨ëœ ê·¸ë˜í”„ êµ¬ì„± (ì›Œí¬í”Œë¡œìš° ì„¤ê³„)
# =============================================================================

def create_graph():
    """ë©”ëª¨ë¦¬ ê¸°ëŠ¥ì´ ì¥ì°©ëœ ì—ì´ì „íŠ¸ ìˆœì„œë„ë¥¼ ë§Œë“­ë‹ˆë‹¤."""
    # 1. íë¦„ë„ ê·¸ë¦´ ìº”ë²„ìŠ¤(StateGraph) ì¤€ë¹„
    builder = StateGraph(MessagesState)
    
    # 2. í•„ìš”í•œ ê° ë‹¨ê³„ë¥¼ ë…¸ë“œë¡œ ë“±ë¡
    builder.add_node("agent", agent_node)
    builder.add_node("tools", ToolNode(tools))
    
    # 3. ì‹œì‘ì  ì—°ê²°
    builder.add_edge(START, "agent")
    
    # 4. 'ìƒê°(agent)' ë‹¨ê³„ í›„ ë„êµ¬ë¥¼ ì“¸ì§€ ëë‚¼ì§€(END) ê²°ì •í•˜ëŠ” ê¸¸ì„ ë§Œë“­ë‹ˆë‹¤.
    builder.add_conditional_edges(
        "agent",
        tools_condition # ë„êµ¬ í˜¸ì¶œ ìš”ì²­ì´ ìˆëŠ”ì§€ ì²´í¬í•´ì£¼ëŠ” ë‚´ì¥ í•¨ìˆ˜
    )
    
    # 5. ë„êµ¬ë¥¼ ì¼ìœ¼ë©´ ë‹¤ì‹œ 'ìƒê°(agent)'ìœ¼ë¡œ ëŒì•„ì˜¤ê²Œ í•©ë‹ˆë‹¤.
    builder.add_edge("tools", "agent")
    
    # 6. â­ ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„: ëŒ€í™” ì €ì¥ì†Œ(MemorySaver) ë§Œë“¤ê¸°
    # ì´ ê°ì²´ê°€ í”„ë¡œê·¸ë¨ì´ ì¼œì ¸ ìˆëŠ” ë™ì•ˆ ëŒ€í™” ë‚´ìš©ì„ ê¸°ì–µí•´ì¤ë‹ˆë‹¤.
    memory = MemorySaver()
    
    # 7. ê·¸ë˜í”„ë¥¼ ì™„ì„±(ì»´íŒŒì¼)í•  ë•Œ ì´ ì €ì¥ì†Œë¥¼ 'checkpointer'ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
    # ì´ì œ ì´ ê·¸ë˜í”„ëŠ” ëŒ€í™”ë°© IDë¥¼ í†µí•´ ì„œë¡œ ë‹¤ë¥¸ ëŒ€í™”ë¥¼ êµ¬ë¶„í•´ì„œ ê¸°ì–µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    return builder.compile(checkpointer=memory)


# =============================================================================
# â–¶ï¸ 4. ëŒ€í™”ë°©(Thread)ë³„ ì‹¤í–‰ í•¨ìˆ˜
# =============================================================================

def run_chat(app, thread_id: str, query: str):
    """ì§€ì •í•œ ëŒ€í™”ë°© ID(thread_id)ë¥¼ ì‚¬ìš©í•˜ì—¬ ëŒ€í™”ë¥¼ ë‚˜ëˆ•ë‹ˆë‹¤."""
    # 1. ì–´ë–¤ ëŒ€í™”ë°©ì—ì„œ ì´ì•¼ê¸°í• ì§€ 'config' ì„¤ì •ì„ ë§Œë“­ë‹ˆë‹¤.
    # thread_idê°€ ê°™ìœ¼ë©´ AIëŠ” ì˜ˆì „ ëŒ€í™” ë‚´ìš©ì„ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
    config = {"configurable": {"thread_id": thread_id}}
    
    print(f"\n{'-'*40}")
    print(f"ğŸ’¬ [ë°© ID: {thread_id}] ì‚¬ìš©ì: {query}")
    
    try:
        # 2. ì§ˆë¬¸ê³¼ ì„¤ì •ì„ ë‹´ì•„ ê·¸ë˜í”„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
        result = app.invoke(
            {"messages": [HumanMessage(content=query)]},
            config=config # ì—¬ê¸°ì„œ ëŒ€í™”ë°© ì •ë³´ë¥¼ ë„˜ê¹ë‹ˆë‹¤.
        )
        
        # 3. ë§ˆì§€ë§‰ ëŒ€ë‹µì„ í™”ë©´ì— ì¶œë ¥í•©ë‹ˆë‹¤.
        final_answer = result["messages"][-1].content
        print(f"ğŸ¤– AI: {final_answer}")
        
    except Exception as e:
        log_llm_error(e)
        print(f"âŒ ëŒ€í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")


# =============================================================================
# ğŸš€ 5. í”„ë¡œê·¸ë¨ ì‹¤ì œ ì‹œì‘ (CLI)
# =============================================================================

if __name__ == "__main__":
    print("\n" + "ğŸ§  ë©”ëª¨ë¦¬(ê¸°ì–µ) ì—ì´ì „íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤! ğŸ§ ")
    print("ì´ ì—ì´ì „íŠ¸ëŠ” ë‹¹ì‹ ì´ í–ˆë˜ ë§ì„ ê¸°ì–µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    print("- '/thread ë°©ì´ë¦„' : ëŒ€í™”ë°©ì„ ë°”ê¿‰ë‹ˆë‹¤ (ì˜ˆ: /thread room2)")
    print("- 'q', 'exit' : í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.\n")
    
    # 1. ê¸°ì–µ ê¸°ëŠ¥ì´ ìˆëŠ” ì—ì´ì „íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    app = create_graph()
    
    # 2. ì²˜ìŒ ì‚¬ìš©í•  ê¸°ë³¸ ëŒ€í™”ë°© IDë¥¼ ì •í•©ë‹ˆë‹¤.
    current_thread = "main_room"
    
    while True:
        try:
            # ì§ˆë¬¸ ì…ë ¥ ë°›ê¸°
            user_input = input(f"ğŸ™‹ [í˜„ìœ„ì¹˜: {current_thread}] : ").strip()
            
            if not user_input: continue
                
            # 'q' ë“±ì„ ì…ë ¥í•˜ë©´ ì¢…ë£Œ
            if user_input.lower() in ("quit", "exit", "q"):
                print("ğŸ‘‹ ëŒ€í™” ê¸°ë¡ì„ ì§€ìš°ê³  ì¢…ë£Œí•©ë‹ˆë‹¤. ë‹¤ìŒì— ë´ìš”!")
                break
            
            # ëŒ€í™”ë°©ì„ ë°”ê¾¸ê³  ì‹¶ì„ ë•Œ (/thread ì´ë¦„ ì…ë ¥)
            if user_input.startswith("/thread "):
                new_thread = user_input.split(" ")[1]
                print(f"ğŸ”„ ëŒ€í™”ë°©ì„ '{new_thread}'ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤. ì´ì „ ê¸°ì–µì€ ê±°ê¸° ë‚¨ì•„ìˆìŠµë‹ˆë‹¤.")
                current_thread = new_thread
                continue

            # ì…ë ¥í•œ ë°© IDì™€ ì§ˆë¬¸ìœ¼ë¡œ ëŒ€í™”ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
            run_chat(app, current_thread, user_input)
            
        except KeyboardInterrupt:
            print("\nğŸ‘‹ í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
            break
        except Exception as e:
            print(f"\nâš ï¸ ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë°œìƒ: {e}")
            break
