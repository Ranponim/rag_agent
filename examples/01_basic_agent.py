# -*- coding: utf-8 -*-
"""
============================================================================
ğŸ“š 01. Basic Agent ì˜ˆì œ - LangGraph ê¸°ë³¸ ê°œë… í•™ìŠµ
============================================================================

ì´ ì˜ˆì œëŠ” LangGraphì˜ ìµœì‹  í‘œì¤€ íŒ¨í„´ì„ ì ìš©í•œ ê¸°ë³¸ Agentì…ë‹ˆë‹¤.
`MessagesState`ì™€ `tools_condition`ì„ ì‚¬ìš©í•˜ì—¬ ê°„ê²°í•˜ê³  í‘œì¤€ì ì¸ ê·¸ë˜í”„ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.

ğŸ¯ í•™ìŠµ ëª©í‘œ:
    1. StateGraph(MessagesState) í‘œì¤€ êµ¬ì¡° ì´í•´
    2. prebuilt.tools_conditionì„ ì´ìš©í•œ ì¡°ê±´ë¶€ ë¶„ê¸° í‘œì¤€í™”
    3. LLMì— ë„êµ¬ ë°”ì¸ë”© ë° ìƒíƒœ ê´€ë¦¬
    4. GPT-OSS(vLLM) Harmony í¬ë§· í˜¸í™˜ì„± ì²˜ë¦¬

ğŸ’¡ í•µì‹¬ ê°œë…:
    - StateGraph: ìƒíƒœ(State)ë¥¼ ê°€ì§„ ë…¸ë“œë“¤ì˜ íë¦„ì„ ì •ì˜í•˜ëŠ” ê·¸ë˜í”„
    - Node: ê·¸ë˜í”„ì˜ ê° ë‹¨ê³„ë¥¼ ìˆ˜í–‰í•˜ëŠ” í•¨ìˆ˜
    - Edge: ë…¸ë“œ ê°„ì˜ ì—°ê²° (ë‹¤ìŒì— ì–´ë–¤ ë…¸ë“œë¡œ ê°ˆì§€)
    - Tool: LLMì´ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ì™¸ë¶€ í•¨ìˆ˜

ì‹¤í–‰ ë°©ë²•:
    python examples/01_basic_agent.py
    
    ì‹¤í–‰ í›„ CLIì—ì„œ ì§ˆë¬¸ì„ ì…ë ¥í•˜ë©´ Agentê°€ ì‘ë‹µí•©ë‹ˆë‹¤.
    ì¢…ë£Œ: 'quit', 'exit', ë˜ëŠ” 'q' ì…ë ¥
"""

# =============================================================================
# ğŸ“¦ í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„í¬íŠ¸
# =============================================================================

# Python í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬
import sys                      # ì‹œìŠ¤í…œ ê²½ë¡œ ì¡°ì‘ìš© (í”„ë¡œì íŠ¸ ëª¨ë“ˆ ì„í¬íŠ¸ë¥¼ ìœ„í•´)
from pathlib import Path        # íŒŒì¼/í´ë” ê²½ë¡œë¥¼ ê°ì²´ì§€í–¥ì ìœ¼ë¡œ ë‹¤ë£¨ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬
from typing import Annotated, Literal  
# - Annotated: íƒ€ì…ì— ì¶”ê°€ ë©”íƒ€ë°ì´í„°ë¥¼ ë¶™ì¼ ë•Œ ì‚¬ìš© (LangGraph ìƒíƒœ ì—…ë°ì´íŠ¸ ë°©ì‹ ì§€ì •)
# - Literal: íŠ¹ì • ê°’ë“¤ë§Œ í—ˆìš©í•˜ëŠ” íƒ€ì… (ì˜ˆ: Literal["a", "b"]ëŠ” "a" ë˜ëŠ” "b"ë§Œ ê°€ëŠ¥)

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ë¥¼ Python ê²½ë¡œì— ì¶”ê°€
# __file__: í˜„ì¬ íŒŒì¼ì˜ ê²½ë¡œ
# .parent: ìƒìœ„ í´ë” (examples í´ë”)
# .parent.parent: ê·¸ ìœ„ í´ë” (í”„ë¡œì íŠ¸ ë£¨íŠ¸)
# ì´ë ‡ê²Œ í•´ì•¼ config, utils ê°™ì€ í”„ë¡œì íŠ¸ ëª¨ë“ˆì„ import í•  ìˆ˜ ìˆìŒ
sys.path.insert(0, str(Path(__file__).parent.parent))

# -----------------------------------------------------------------------------
# ğŸ” ë””ë²„ê·¸ ëª¨ë“œ ì„¤ì • (ê°œë°œ ì¤‘ì—ë§Œ ì‚¬ìš©, ìš´ì˜ ì‹œ ë„ê¸°)
# -----------------------------------------------------------------------------
import langchain
langchain.debug = True  # Trueë¡œ ì„¤ì •í•˜ë©´ LLMê³¼ ì£¼ê³ ë°›ëŠ” ëª¨ë“  ë©”ì‹œì§€ê°€ ì½˜ì†”ì— ì¶œë ¥ë¨

# ë” ìƒì„¸í•œ ë¡œê·¸ê°€ í•„ìš”í•˜ë©´ ì•„ë˜ ì£¼ì„ì„ í•´ì œ:
# import logging
# logging.getLogger("langchain").setLevel(logging.DEBUG)  # LangChain ë‚´ë¶€ ë¡œê·¸
# logging.getLogger("openai").setLevel(logging.DEBUG)     # OpenAI API í˜¸ì¶œ ë¡œê·¸
# logging.getLogger("httpx").setLevel(logging.DEBUG)      # HTTP í†µì‹  ë¡œê·¸

# -----------------------------------------------------------------------------
# ğŸ”— LangChain í•µì‹¬ ëª¨ë“ˆ ì„í¬íŠ¸
# -----------------------------------------------------------------------------

# ë©”ì‹œì§€ íƒ€ì…: LLMê³¼ì˜ ëŒ€í™”ì—ì„œ ì‚¬ìš©ë˜ëŠ” ë©”ì‹œì§€ êµ¬ì¡°
from langchain_core.messages import HumanMessage, SystemMessage
# - HumanMessage: ì‚¬ìš©ìê°€ ë³´ë‚´ëŠ” ë©”ì‹œì§€ (ì§ˆë¬¸, ìš”ì²­ ë“±)
# - SystemMessage: AIì—ê²Œ ì£¼ëŠ” ì§€ì¹¨/ì—­í•  ì„¤ì • (ì˜ˆ: "ë‹¹ì‹ ì€ ë„ì›€ì´ ë˜ëŠ” ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤")

# ë„êµ¬(Tool) ì •ì˜ìš© ë°ì½”ë ˆì´í„°
from langchain_core.tools import tool
# @tool ë°ì½”ë ˆì´í„°ë¥¼ í•¨ìˆ˜ì— ë¶™ì´ë©´ LLMì´ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ë„êµ¬ë¡œ ë³€í™˜ë¨

# -----------------------------------------------------------------------------
# ğŸ”— LangGraph í•µì‹¬ ëª¨ë“ˆ ì„í¬íŠ¸
# -----------------------------------------------------------------------------

from langgraph.graph import StateGraph, MessagesState, START, END
# - StateGraph: ìƒíƒœ ê¸°ë°˜ ê·¸ë˜í”„ë¥¼ ë§Œë“œëŠ” ë¹Œë” í´ë˜ìŠ¤
# - MessagesState: ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ë¥¼ ê´€ë¦¬í•˜ëŠ” í‘œì¤€ ìƒíƒœ (ëŒ€í™” íˆìŠ¤í† ë¦¬ ìë™ ê´€ë¦¬)
# - START: ê·¸ë˜í”„ì˜ ì‹œì‘ì ì„ ë‚˜íƒ€ë‚´ëŠ” íŠ¹ìˆ˜ ìƒìˆ˜
# - END: ê·¸ë˜í”„ì˜ ì¢…ë£Œì ì„ ë‚˜íƒ€ë‚´ëŠ” íŠ¹ìˆ˜ ìƒìˆ˜

from langgraph.prebuilt import ToolNode, tools_condition
# - ToolNode: ë„êµ¬ ì‹¤í–‰ì„ ë‹´ë‹¹í•˜ëŠ” ë¯¸ë¦¬ ë§Œë“¤ì–´ì§„ ë…¸ë“œ (ì§ì ‘ êµ¬í˜„ ë¶ˆí•„ìš”)
# - tools_condition: "ë„êµ¬ë¥¼ í˜¸ì¶œí•´ì•¼ í•˜ë‚˜?"ë¥¼ ìë™ íŒë‹¨í•˜ëŠ” ì¡°ê±´ í•¨ìˆ˜

# -----------------------------------------------------------------------------
# ğŸ”— í”„ë¡œì íŠ¸ ë‚´ë¶€ ìœ í‹¸ë¦¬í‹° ì„í¬íŠ¸
# -----------------------------------------------------------------------------

from config.settings import get_settings  
# í™˜ê²½ ë³€ìˆ˜ì—ì„œ ì„¤ì •ì„ ì½ì–´ì˜¤ëŠ” í•¨ìˆ˜ (API í‚¤, ëª¨ë¸ëª…, ì„œë²„ URL ë“±)

from utils.llm_factory import get_llm, log_llm_error
# - get_llm: ì„¤ì •ì— ë§ëŠ” LLM ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ” íŒ©í† ë¦¬ í•¨ìˆ˜
# - log_llm_error: LLM ê´€ë ¨ ì˜¤ë¥˜ë¥¼ ìƒì„¸í•˜ê²Œ ë¡œê¹…í•˜ëŠ” í—¬í¼ í•¨ìˆ˜

from utils.harmony_parser import parse_harmony_tool_call, clean_history_for_harmony
# GPT-OSS (vLLM ê¸°ë°˜ ë¡œì»¬ LLM)ì™€ì˜ í˜¸í™˜ì„±ì„ ìœ„í•œ ìœ í‹¸ë¦¬í‹°
# - parse_harmony_tool_call: Harmony í¬ë§· ì‘ë‹µì„ LangChain í‘œì¤€ìœ¼ë¡œ ë³€í™˜
# - clean_history_for_harmony: ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ vLLMì´ ì´í•´í•  ìˆ˜ ìˆëŠ” í˜•ì‹ìœ¼ë¡œ ì •ì œ


# =============================================================================
# ğŸ› ï¸ 1. ë„êµ¬(Tool) ì •ì˜
# =============================================================================
# 
# LLMì´ "ì™¸ë¶€ ì„¸ê³„"ì™€ ìƒí˜¸ì‘ìš©í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” í•¨ìˆ˜ë“¤ì…ë‹ˆë‹¤.
# @tool ë°ì½”ë ˆì´í„°ë¥¼ ë¶™ì´ë©´ LangChainì´ ìë™ìœ¼ë¡œ ë„êµ¬ ìŠ¤í‚¤ë§ˆë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
# 
# ğŸ’¡ ë„êµ¬ì˜ docstring(ì„¤ëª…)ì´ ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤!
#    LLMì€ ì´ ì„¤ëª…ì„ ì½ê³  ì–¸ì œ ì´ ë„êµ¬ë¥¼ ì‚¬ìš©í• ì§€ ê²°ì •í•©ë‹ˆë‹¤.
# =============================================================================

@tool
def get_weather(city: str) -> str:
    """
    íŠ¹ì • ë„ì‹œì˜ ë‚ ì”¨ ì •ë³´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
    
    Args:
        city: ë‚ ì”¨ë¥¼ í™•ì¸í•  ë„ì‹œ ì´ë¦„ (ì˜ˆ: "ì„œìš¸", "ë¶€ì‚°")
        
    Returns:
        í•´ë‹¹ ë„ì‹œì˜ ë‚ ì”¨ ì •ë³´ ë¬¸ìì—´
        
    ì‚¬ìš© ì˜ˆì‹œ:
        LLMì´ "ì„œìš¸ ë‚ ì”¨ ì–´ë•Œ?"ë¼ëŠ” ì§ˆë¬¸ì„ ë°›ìœ¼ë©´
        ì´ ë„êµ¬ë¥¼ í˜¸ì¶œí•˜ì—¬ ì‹¤ì œ ë‚ ì”¨ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    """
    # ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ë‚ ì”¨ APIë¥¼ í˜¸ì¶œí•˜ê² ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” ë”ë¯¸ ë°ì´í„° ì‚¬ìš©
    weather_data = {
        "ì„œìš¸": "ë§‘ìŒ, 15Â°C",
        "ë¶€ì‚°": "íë¦¼, 18Â°C",
        "ì œì£¼": "ë¹„, 20Â°C",
        "ì¸ì²œ": "ë§‘ìŒ, 14Â°C",
    }
    # dict.get(key, default): í‚¤ê°€ ì—†ìœ¼ë©´ default ê°’ ë°˜í™˜
    return weather_data.get(city, f"{city}ì˜ ë‚ ì”¨ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")


@tool
def calculate(expression: str) -> str:
    """
    ìˆ˜í•™ í‘œí˜„ì‹ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
    
    Args:
        expression: ê³„ì‚°í•  ìˆ˜í•™ í‘œí˜„ì‹ (ì˜ˆ: "2 + 3 * 4", "100 / 5")
        
    Returns:
        ê³„ì‚° ê²°ê³¼ ë¬¸ìì—´
        
    âš ï¸ ì£¼ì˜: eval()ì€ ë³´ì•ˆìƒ ìœ„í—˜í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ 
            ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ì•ˆì „í•œ ìˆ˜ì‹ íŒŒì„œ ì‚¬ìš© ê¶Œì¥
    """
    try:
        # eval(): ë¬¸ìì—´ì„ Python ì½”ë“œë¡œ ì‹¤í–‰ (ìœ„í—˜í•  ìˆ˜ ìˆìŒ!)
        result = eval(expression)
        return f"ê²°ê³¼: {result}"
    except Exception as e:
        # ì˜ëª»ëœ ìˆ˜ì‹ì´ ì…ë ¥ë˜ë©´ ì˜¤ë¥˜ ë©”ì‹œì§€ ë°˜í™˜
        return f"ê³„ì‚° ì˜¤ë¥˜: {str(e)}"


# ë„êµ¬ ë¦¬ìŠ¤íŠ¸: ê·¸ë˜í”„ì—ì„œ ì‚¬ìš©í•  ëª¨ë“  ë„êµ¬ë¥¼ ëª¨ì•„ë‘ 
# ì´ ë¦¬ìŠ¤íŠ¸ë¥¼ LLMì— ë°”ì¸ë”©í•˜ê³ , ToolNodeì—ë„ ì „ë‹¬í•¨
tools = [get_weather, calculate]


# =============================================================================
# ğŸ¤– 2. Agent ë…¸ë“œ ì •ì˜
# =============================================================================
#
# ë…¸ë“œ(Node)ë€?
# - ê·¸ë˜í”„ì—ì„œ í•˜ë‚˜ì˜ "ì‘ì—… ë‹¨ê³„"ë¥¼ ë‹´ë‹¹í•˜ëŠ” í•¨ìˆ˜
# - ì…ë ¥: í˜„ì¬ ìƒíƒœ(State)
# - ì¶œë ¥: ìƒíƒœ ì—…ë°ì´íŠ¸ (ë³€ê²½í•  í•„ë“œì™€ ê°’)
#
# Agent ë…¸ë“œì˜ ì—­í• :
# - ì‚¬ìš©ì ë©”ì‹œì§€ì™€ ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ ë°›ì•„ì„œ LLMì—ê²Œ ì „ë‹¬
# - LLMì˜ ì‘ë‹µì„ ë°›ì•„ì„œ ìƒíƒœì— ì¶”ê°€
# =============================================================================

def agent_node(state: MessagesState):
    """
    Agent ë…¸ë“œ: ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ LLM ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤.
    
    Args:
        state: í˜„ì¬ ê·¸ë˜í”„ ìƒíƒœ (MessagesState íƒ€ì…)
               state["messages"]ì— ì§€ê¸ˆê¹Œì§€ì˜ ëŒ€í™” íˆìŠ¤í† ë¦¬ê°€ ë‹´ê²¨ìˆìŒ
               
    Returns:
        dict: ìƒíƒœ ì—…ë°ì´íŠ¸ ({"messages": [ìƒˆ ë©”ì‹œì§€]})
              MessagesStateëŠ” ìë™ìœ¼ë¡œ ê¸°ì¡´ ë¦¬ìŠ¤íŠ¸ì— appendí•¨
    
    ğŸ’¡ í‘œì¤€ íŒ¨í„´:
       - LLMì— ë„êµ¬ ì •ë³´ë¥¼ bind_tools()ë¡œ ì „ë‹¬
       - ì „ì²´ ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ë¥¼ LLMì— ì „ë‹¬í•˜ì—¬ ë¬¸ë§¥ ìœ ì§€
       - ì‘ë‹µë§Œ ë°˜í™˜í•˜ë©´ ìƒíƒœ ê´€ë¦¬ëŠ” LangGraphê°€ ì²˜ë¦¬
    """
    import json  # ë””ë²„ê¹…ìš© JSON ì¶œë ¥ì„ ìœ„í•´ ì„í¬íŠ¸
    
    # -------------------------------------------------------------------------
    # Step 1: LLM ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° ë„êµ¬ ë°”ì¸ë”©
    # -------------------------------------------------------------------------
    
    # ì„¤ì •ì— ë§ëŠ” LLM ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸° (OpenAI, ë¡œì»¬ vLLM ë“±)
    llm = get_llm()
    
    # LLMì— ë„êµ¬ ì •ë³´ ì „ë‹¬ (bind_tools)
    # LLMì€ ì´ ì •ë³´ë¥¼ ë³´ê³  "ì–¸ì œ ì–´ë–¤ ë„êµ¬ë¥¼ í˜¸ì¶œí• ì§€" ê²°ì •í•¨
    # 
    # ğŸ’¡ parallel_tool_calls=False ì˜µì…˜:
    #    - ë§ì€ ë¡œì»¬ LLM (vLLM ë“±)ì€ ë³‘ë ¬ ë„êµ¬ í˜¸ì¶œì„ ì§€ì›í•˜ì§€ ì•ŠìŒ
    #    - ì´ ì˜µì…˜ì„ Falseë¡œ ì„¤ì •í•˜ë©´ í•œ ë²ˆì— í•˜ë‚˜ì˜ ë„êµ¬ë§Œ í˜¸ì¶œ
    llm_with_tools = llm.bind_tools(tools, parallel_tool_calls=False)
    
    # -------------------------------------------------------------------------
    # Step 2: ì‹œìŠ¤í…œ ë©”ì‹œì§€ ë° ëŒ€í™” íˆìŠ¤í† ë¦¬ êµ¬ì„±
    # -------------------------------------------------------------------------
    
    # ì‹œìŠ¤í…œ ë©”ì‹œì§€: AIì˜ ì—­í• /ì„±ê²©ì„ ì •ì˜
    # ì´ ë©”ì‹œì§€ëŠ” í•­ìƒ ëŒ€í™”ì˜ ë§¨ ì•ì— ìœ„ì¹˜
    sys_msg = SystemMessage(
        content="ë‹¹ì‹ ì€ ë‚ ì”¨ ì¡°íšŒì™€ ê³„ì‚°ì„ ë•ëŠ” ìœ ìš©í•œ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤."
    )

    # ì „ì²´ ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ êµ¬ì„±: [ì‹œìŠ¤í…œ ë©”ì‹œì§€] + [ëŒ€í™” íˆìŠ¤í† ë¦¬]
    messages = [sys_msg] + state["messages"]
    
    # -------------------------------------------------------------------------
    # Step 3: vLLM í˜¸í™˜ì„± ì²˜ë¦¬ (History Cleaning)
    # -------------------------------------------------------------------------
    
    # GPT-OSS(vLLM)ëŠ” íŠ¹ì • ë©”ì‹œì§€ í˜•ì‹ì„ ì‹«ì–´í•¨:
    # - tool_callsê°€ í¬í•¨ëœ ë©”ì‹œì§€
    # - roleì´ "tool"ì¸ ë©”ì‹œì§€
    # 
    # clean_history_for_harmony()ê°€ ì´ëŸ° ë©”ì‹œì§€ë¥¼ ë³€í™˜:
    # - AIMessage(tool_calls=[...]) â†’ AIMessage(content="Calling tool...")
    # - ToolMessage â†’ HumanMessage(content="Observation: ...")
    cleaned_messages = clean_history_for_harmony(messages)
    
    # -------------------------------------------------------------------------
    # Step 4: LLM í˜¸ì¶œ
    # -------------------------------------------------------------------------
    
    # invoke(): ë™ê¸° ë°©ì‹ìœ¼ë¡œ LLM í˜¸ì¶œ (ì‘ë‹µ ì „ì²´ê°€ ì˜¬ ë•Œê¹Œì§€ ëŒ€ê¸°)
    # stream(): ë¹„ë™ê¸° ìŠ¤íŠ¸ë¦¬ë° (ê¸€ìê°€ í•˜ë‚˜ì”© ì¶œë ¥ë˜ëŠ” íš¨ê³¼)
    response = llm_with_tools.invoke(cleaned_messages)
    
    # -------------------------------------------------------------------------
    # Step 5: ë””ë²„ê¹… ë¡œê·¸ (ê°œë°œ ì¤‘ì—ë§Œ ì‚¬ìš©)
    # -------------------------------------------------------------------------
    
    print(f"\n{'='*60}")
    print(f"ğŸ” [DEBUG] LLM ì‘ë‹µ ë¶„ì„")
    print(f"{'='*60}")
    print(f"ğŸ“Œ response type: {type(response).__name__}")
    print(f"ğŸ“Œ response.content: {repr(response.content)}")
    print(f"ğŸ“Œ response.tool_calls: {response.tool_calls}")
    print(f"ğŸ“Œ response.additional_kwargs: {json.dumps(response.additional_kwargs, indent=2, ensure_ascii=False, default=str)}")
    
    # contentê°€ JSON í˜•ì‹ì¸ì§€ í™•ì¸ (Harmony í¬ë§· ê°ì§€ìš©)
    if response.content and isinstance(response.content, str):
        try:
            parsed = json.loads(response.content)
            print(f"ğŸ“Œ content JSON íŒŒì‹± ê²°ê³¼: {json.dumps(parsed, indent=2, ensure_ascii=False)}")
        except json.JSONDecodeError:
            print(f"ğŸ“Œ contentëŠ” JSONì´ ì•„ë‹˜ (ì¼ë°˜ í…ìŠ¤íŠ¸)")
    print(f"{'='*60}\n")
    
    # -------------------------------------------------------------------------
    # Step 6: Harmony í¬ë§· íŒŒì‹± (GPT-OSS í˜¸í™˜ì„±)
    # -------------------------------------------------------------------------
    
    # GPT-OSSëŠ” ë„êµ¬ í˜¸ì¶œì„ í‘œì¤€ í˜•ì‹ì´ ì•„ë‹Œ "Harmony í¬ë§·"ìœ¼ë¡œ ë°˜í™˜:
    # - í‘œì¤€: response.tool_calls = [{"name": "get_weather", "args": {...}}]
    # - Harmony: response.content = '{"city": "ì„œìš¸"}'
    #
    # parse_harmony_tool_call()ì´ contentì˜ JSONì„ ë¶„ì„í•´ì„œ
    # ì–´ë–¤ ë„êµ¬ë¥¼ í˜¸ì¶œí•˜ë ¤ëŠ”ì§€ ì¶”ë¡ í•˜ê³  tool_callsë¥¼ ì±„ì›Œì¤Œ
    response = parse_harmony_tool_call(response, tools)
    
    if response.tool_calls:
        print(f"ğŸ”§ [HARMONY] tool_calls ë³€í™˜ ì™„ë£Œ: {[tc['name'] for tc in response.tool_calls]}")
    
    # -------------------------------------------------------------------------
    # Step 7: ìƒíƒœ ì—…ë°ì´íŠ¸ ë°˜í™˜
    # -------------------------------------------------------------------------
    
    # MessagesStateë¥¼ ì‚¬ìš©í•˜ë©´ ë°˜í™˜í•œ ë©”ì‹œì§€ê°€ ìë™ìœ¼ë¡œ ë¦¬ìŠ¤íŠ¸ì— appendë¨
    # ì¦‰, {"messages": [response]}ë¥¼ ë°˜í™˜í•˜ë©´
    # ê¸°ì¡´ state["messages"]ì— responseê°€ ì¶”ê°€ë¨
    return {"messages": [response]}


# =============================================================================
# ğŸ”€ 3. ê·¸ë˜í”„ êµ¬ì„± (í‘œì¤€ íŒ¨í„´)
# =============================================================================
#
# ê·¸ë˜í”„ êµ¬ì„± ìˆœì„œ:
# 1. StateGraph ë¹Œë” ìƒì„± (ìƒíƒœ íƒ€ì… ì§€ì •)
# 2. ë…¸ë“œ ì¶”ê°€ (ì‘ì—… ë‹¨ê³„ë“¤)
# 3. ì—£ì§€ ì¶”ê°€ (ë…¸ë“œ ê°„ ì—°ê²°)
# 4. ì»´íŒŒì¼ (ì‹¤í–‰ ê°€ëŠ¥í•œ ê·¸ë˜í”„ë¡œ ë³€í™˜)
#
# ì´ ì˜ˆì œì˜ ê·¸ë˜í”„ êµ¬ì¡° (ReAct íŒ¨í„´):
#
#   START â†’ agent â†’ (ë„êµ¬ í•„ìš”?) â†’ tools â†’ agent â†’ ... â†’ END
#                        â†“
#                   (í•„ìš”ì—†ìŒ) â†’ END
# =============================================================================

def create_agent_graph():
    """
    LangGraph í‘œì¤€ íŒ¨í„´ì„ ì ìš©í•œ Agent ê·¸ë˜í”„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    
    Returns:
        CompiledGraph: ì‹¤í–‰ ê°€ëŠ¥í•œ ì»´íŒŒì¼ëœ ê·¸ë˜í”„
        
    ğŸ’¡ ì´ í•¨ìˆ˜ê°€ ë°˜í™˜í•˜ëŠ” ê·¸ë˜í”„ëŠ” ë§ˆì¹˜ í•¨ìˆ˜ì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
       result = graph.invoke({"messages": [HumanMessage(content="ì•ˆë…•")]})
    """
    
    # -------------------------------------------------------------------------
    # Step 1: ê·¸ë˜í”„ ë¹Œë” ì´ˆê¸°í™”
    # -------------------------------------------------------------------------
    
    # MessagesStateë¥¼ ì‚¬ìš©í•œ í‘œì¤€ ê·¸ë˜í”„ ë¹Œë” ìƒì„±
    # MessagesStateëŠ” {"messages": [Message, Message, ...]} í˜•íƒœì˜ ìƒíƒœ
    builder = StateGraph(MessagesState)
    
    # -------------------------------------------------------------------------
    # Step 2: ë…¸ë“œ ì¶”ê°€
    # -------------------------------------------------------------------------
    
    # add_node(ë…¸ë“œ_ì´ë¦„, ë…¸ë“œ_í•¨ìˆ˜)
    # - ë…¸ë“œ ì´ë¦„: ê·¸ë˜í”„ ë‚´ì—ì„œ ì´ ë…¸ë“œë¥¼ ì‹ë³„í•˜ëŠ” ë¬¸ìì—´
    # - ë…¸ë“œ í•¨ìˆ˜: ì‹¤ì œ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” í•¨ìˆ˜
    
    # Agent ë…¸ë“œ: LLMì„ í˜¸ì¶œí•˜ì—¬ ì‘ë‹µ ìƒì„±
    builder.add_node("agent", agent_node)
    
    # Tool ë…¸ë“œ: LLMì´ ìš”ì²­í•œ ë„êµ¬ë¥¼ ì‹¤í–‰
    # ToolNodeëŠ” prebuilt ì»´í¬ë„ŒíŠ¸ë¡œ, ë„êµ¬ ë¦¬ìŠ¤íŠ¸ë§Œ ë„˜ê¸°ë©´
    # ìë™ìœ¼ë¡œ ë„êµ¬ ì‹¤í–‰ ë° ê²°ê³¼ ë°˜í™˜ì„ ì²˜ë¦¬í•¨
    builder.add_node("tools", ToolNode(tools))
    
    # -------------------------------------------------------------------------
    # Step 3: ì—£ì§€ ì¶”ê°€
    # -------------------------------------------------------------------------
    
    # 3-1. ì‹œì‘ ì—£ì§€: START â†’ agent
    # ê·¸ë˜í”„ê°€ ì‹œì‘ë˜ë©´ ë¬´ì¡°ê±´ agent ë…¸ë“œë¶€í„° ì‹¤í–‰
    builder.add_edge(START, "agent")
    
    # 3-2. ì¡°ê±´ë¶€ ì—£ì§€: agent â†’ (ì¡°ê±´ íŒë‹¨) â†’ tools ë˜ëŠ” END
    # 
    # tools_condition í•¨ìˆ˜ëŠ” LangGraphê°€ ë¯¸ë¦¬ ì œê³µí•˜ëŠ” í‘œì¤€ ì¡°ê±´ í•¨ìˆ˜:
    # - LLM ì‘ë‹µì— tool_callsê°€ ìˆìœ¼ë©´ â†’ "tools" ë°˜í™˜
    # - tool_callsê°€ ì—†ìœ¼ë©´ â†’ END ë°˜í™˜
    #
    # ì´ì „ ë²„ì „ì—ì„œëŠ” ì´ëŸ° ì¡°ê±´ í•¨ìˆ˜ë¥¼ ì§ì ‘ ì‘ì„±í•´ì•¼ í–ˆì§€ë§Œ,
    # ì´ì œëŠ” tools_conditionì„ ì“°ë©´ ë¨!
    builder.add_conditional_edges(
        "agent",           # ì´ ë…¸ë“œê°€ ëë‚˜ë©´
        tools_condition,   # ì´ ì¡°ê±´ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ì—¬
                          # ë°˜í™˜ëœ ë¬¸ìì—´ì— í•´ë‹¹í•˜ëŠ” ë…¸ë“œë¡œ ì´ë™
    )
    
    # 3-3. ì¼ë°˜ ì—£ì§€: tools â†’ agent
    # ë„êµ¬ ì‹¤í–‰ì´ ëë‚˜ë©´ ë‹¤ì‹œ agentë¡œ ëŒì•„ê° (ReAct íŒ¨í„´ì˜ ë£¨í”„)
    # agentëŠ” ë„êµ¬ ê²°ê³¼ë¥¼ ë³´ê³  ìµœì¢… ë‹µë³€ì„ ìƒì„±í•˜ê±°ë‚˜
    # ë” í•„ìš”í•œ ë„êµ¬ê°€ ìˆìœ¼ë©´ ë‹¤ì‹œ í˜¸ì¶œ
    builder.add_edge("tools", "agent")
    
    # -------------------------------------------------------------------------
    # Step 4: ì»´íŒŒì¼
    # -------------------------------------------------------------------------
    
    # compile()ì„ í˜¸ì¶œí•˜ë©´ ì„¤ê³„í•œ ê·¸ë˜í”„ê°€ ì‹¤í–‰ ê°€ëŠ¥í•œ í˜•íƒœë¡œ ë³€í™˜ë¨
    # ë°˜í™˜ëœ ê°ì²´ëŠ” .invoke(), .stream() ë“±ì˜ ë©”ì„œë“œë¡œ ì‹¤í–‰ ê°€ëŠ¥
    return builder.compile()


# =============================================================================
# â–¶ï¸ 4. ì‹¤í–‰ í•¨ìˆ˜
# =============================================================================

def run_agent(query: str):
    """
    Agentë¥¼ ì‹¤í–‰í•˜ì—¬ ì‚¬ìš©ì ì§ˆë¬¸ì— ë‹µë³€í•©ë‹ˆë‹¤.
    
    Args:
        query: ì‚¬ìš©ìì˜ ì§ˆë¬¸ ë¬¸ìì—´
        
    ì‹¤í–‰ íë¦„:
    1. ê·¸ë˜í”„ ìƒì„±
    2. ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ë‹´ì€ ì´ˆê¸° ìƒíƒœë¡œ ê·¸ë˜í”„ ì‹¤í–‰
    3. ìµœì¢… ë©”ì‹œì§€(ë‹µë³€) ì¶œë ¥
    """
    # ë§¤ë²ˆ ìƒˆ ê·¸ë˜í”„ ìƒì„± (ë˜ëŠ” ì „ì—­ìœ¼ë¡œ ìºì‹±í•´ë„ ë¨)
    graph = create_agent_graph()
    
    print(f"\n{'='*60}")
    print(f"ğŸ™‹ ì‚¬ìš©ì: {query}")
    print('='*60)
    
    try:
        # ê·¸ë˜í”„ ì‹¤í–‰ (invoke = ë™ê¸° ì‹¤í–‰)
        # ì´ˆê¸° ìƒíƒœ: ì‚¬ìš©ì ë©”ì‹œì§€ë§Œ ë‹´ê¸´ messages ë¦¬ìŠ¤íŠ¸
        result = graph.invoke(
            {"messages": [HumanMessage(content=query)]}
        )
        
        # ê²°ê³¼ì—ì„œ ë§ˆì§€ë§‰ ë©”ì‹œì§€(AIì˜ ìµœì¢… ë‹µë³€) ì¶”ì¶œ
        final_msg = result["messages"][-1] if result.get("messages") else None
        
        if final_msg:
             print(f"\nğŸ¤– ìµœì¢… ë‹µë³€: {final_msg.content}")

    except Exception as e:
        # LLM ê´€ë ¨ ì˜¤ë¥˜ ìƒì„¸ ë¡œê¹…
        log_llm_error(e)
        print("âŒ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")


# =============================================================================
# ğŸš€ 5. ë©”ì¸ ì‹¤í–‰ë¶€ (CLI ì¸í„°í˜ì´ìŠ¤)
# =============================================================================
#
# ì´ ë¸”ë¡ì€ ì´ íŒŒì¼ì„ ì§ì ‘ ì‹¤í–‰í•  ë•Œë§Œ ì‹¤í–‰ë¨
# (ë‹¤ë¥¸ íŒŒì¼ì—ì„œ importí•  ë•ŒëŠ” ì‹¤í–‰ë˜ì§€ ì•ŠìŒ)
# =============================================================================

if __name__ == "__main__":
    # í”„ë¡œê·¸ë¨ ì‹œì‘ ë©”ì‹œì§€
    print("\n" + "="*60)
    print("ğŸ¤– LangGraph Basic Agent (Standard Pattern)")
    print("="*60)
    print("CLI ëª¨ë“œë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤. ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.")
    print("ì¢…ë£Œí•˜ë ¤ë©´ 'quit', 'exit', ë˜ëŠ” 'q'ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n")
    
    # ë¬´í•œ ë£¨í”„: ì‚¬ìš©ìê°€ ì¢…ë£Œí•  ë•Œê¹Œì§€ ê³„ì† ì§ˆë¬¸-ë‹µë³€ ë°˜ë³µ
    while True:
        try:
            # input(): ì‚¬ìš©ì ì…ë ¥ì„ ë°›ì•„ ë¬¸ìì—´ë¡œ ë°˜í™˜
            # .strip(): ì•ë’¤ ê³µë°± ì œê±°
            query = input("ğŸ™‹ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”: ").strip()
            
            # ë¹ˆ ì…ë ¥ì€ ë¬´ì‹œí•˜ê³  ë‹¤ì‹œ ì…ë ¥ ë°›ê¸°
            if not query:
                continue
            
            # ì¢…ë£Œ ëª…ë ¹ì–´ í™•ì¸ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
            if query.lower() in ("quit", "exit", "q"):
                print("ğŸ‘‹ Agentë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤. ì•ˆë…•íˆ ê°€ì„¸ìš”!")
                break
            
            # Agent ì‹¤í–‰
            run_agent(query)
            
        except KeyboardInterrupt:
            # Ctrl+Cë¥¼ ëˆŒë €ì„ ë•Œ
            print("\nğŸ‘‹ Agentë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤. (Ctrl+C)")
            break
        except EOFError:
            # ì…ë ¥ì´ ëë‚¬ì„ ë•Œ (íŒŒì´í”„ ì…ë ¥ ë“±)
            print("\nğŸ‘‹ Agentë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤. (EOF)")
            break
