# -*- coding: utf-8 -*-
"""
============================================================================
ğŸ“š 02. Naive RAG ì˜ˆì œ - ê¸°ë³¸ RAG íŒŒì´í”„ë¼ì¸ êµ¬í˜„
============================================================================

LangGraphë¥¼ ì‚¬ìš©í•˜ì—¬ ê°€ì¥ ê¸°ë³¸ì ì¸ ê²€ìƒ‰-ìƒì„±(Retrieve-Generate) íŒŒì´í”„ë¼ì¸ì„ êµ¬ì¶•í•©ë‹ˆë‹¤.
StateGraphë¥¼ í™œìš©í•˜ì—¬ ê²€ìƒ‰ ê²°ê³¼ì™€ ìƒì„±ëœ ë‹µë³€ì„ ìƒíƒœë¡œ ê´€ë¦¬í•˜ëŠ” ë°©ë²•ì„ í•™ìŠµí•©ë‹ˆë‹¤.

ğŸ¯ í•™ìŠµ ëª©í‘œ:
    1. RAGì˜ í‘œì¤€ íŒŒì´í”„ë¼ì¸ (Retrieve â†’ Generate) êµ¬í˜„
    2. ì‚¬ìš©ì ì •ì˜ State(TypedDict) ì„¤ê³„
    3. Vector Store ì—°ë™ ë° ê²€ìƒ‰ ë…¸ë“œ êµ¬í˜„

ğŸ’¡ RAGë€?
    Retrieval-Augmented Generation (ê²€ìƒ‰ ì¦ê°• ìƒì„±)
    - LLMì—ê²Œ ì§ˆë¬¸ë§Œ ë˜ì§€ëŠ” ê²ƒì´ ì•„ë‹ˆë¼
    - ë¨¼ì € ê´€ë ¨ ë¬¸ì„œë¥¼ ê²€ìƒ‰(Retrieve)í•˜ê³ 
    - ê·¸ ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ì—¬ ë‹µë³€ì„ ìƒì„±(Generate)í•˜ëŠ” ê¸°ë²•
    - ì´ë¥¼ í†µí•´ LLMì´ í•™ìŠµí•˜ì§€ ì•Šì€ ìµœì‹  ì •ë³´ë„ ë‹µë³€ ê°€ëŠ¥

ê·¸ë˜í”„ êµ¬ì¡°:
    START â†’ retrieve â†’ generate â†’ END
    (ì„ í˜• êµ¬ì¡°, ë¶„ê¸° ì—†ìŒ)

ì‹¤í–‰ ë°©ë²•:
    python examples/02_naive_rag.py
    
    ì‹¤í–‰ í›„ CLIì—ì„œ ì§ˆë¬¸ì„ ì…ë ¥í•˜ë©´ RAG Agentê°€ ì‘ë‹µí•©ë‹ˆë‹¤.
    ì¢…ë£Œ: 'quit', 'exit', ë˜ëŠ” 'q' ì…ë ¥
"""

# =============================================================================
# ğŸ“¦ í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„í¬íŠ¸
# =============================================================================

# Python í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬
import sys                              # ì‹œìŠ¤í…œ ê²½ë¡œ ì¡°ì‘ìš©
from pathlib import Path                # íŒŒì¼ ê²½ë¡œë¥¼ ê°ì²´ì§€í–¥ì ìœ¼ë¡œ ë‹¤ë£¨ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬
from typing import TypedDict, List, Annotated  
# - TypedDict: ë”•ì…”ë„ˆë¦¬ì˜ í‚¤ì™€ ê°’ íƒ€ì…ì„ ì •ì˜í•˜ëŠ” íƒ€ì… íŒíŠ¸
# - List: ë¦¬ìŠ¤íŠ¸ íƒ€ì… íŒíŠ¸ (ì˜ˆ: List[str]ëŠ” ë¬¸ìì—´ ë¦¬ìŠ¤íŠ¸)
# - Annotated: íƒ€ì…ì— ì¶”ê°€ ë©”íƒ€ë°ì´í„° ë¶€ì—¬

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ë¥¼ Python ê²½ë¡œì— ì¶”ê°€í•˜ì—¬ ë‚´ë¶€ ëª¨ë“ˆ import ê°€ëŠ¥í•˜ê²Œ í•¨
sys.path.insert(0, str(Path(__file__).parent.parent))

# .env íŒŒì¼ì—ì„œ í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
import os
from dotenv import load_dotenv
load_dotenv()

# -----------------------------------------------------------------------------
# ğŸ”— LangChain í•µì‹¬ ëª¨ë“ˆ ì„í¬íŠ¸
# -----------------------------------------------------------------------------

from langchain_openai import ChatOpenAI # LLM ëª¨ë¸ í´ë˜ìŠ¤
from langchain_core.documents import Document
# Document: ê²€ìƒ‰ëœ í…ìŠ¤íŠ¸ë¥¼ ë‹´ëŠ” í‘œì¤€ ê°ì²´
# - page_content: ì‹¤ì œ í…ìŠ¤íŠ¸ ë‚´ìš©
# - metadata: ì¶œì²˜, í˜ì´ì§€ ë²ˆí˜¸ ë“± ë¶€ê°€ ì •ë³´

from langchain_core.prompts import ChatPromptTemplate
# ChatPromptTemplate: LLMì—ê²Œ ì „ë‹¬í•  í”„ë¡¬í”„íŠ¸ì˜ í…œí”Œë¦¿
# ë³€ìˆ˜ ìë¦¬ë¥¼ {ë³€ìˆ˜ëª…}ìœ¼ë¡œ ì§€ì •í•˜ê³  ë‚˜ì¤‘ì— ê°’ì„ ì±„ì›€

# -----------------------------------------------------------------------------
# ğŸ”— LangGraph í•µì‹¬ ëª¨ë“ˆ ì„í¬íŠ¸
# -----------------------------------------------------------------------------

from langgraph.graph import StateGraph, START, END
# - StateGraph: ìƒíƒœ ê¸°ë°˜ ê·¸ë˜í”„ ë¹Œë”
# - START: ê·¸ë˜í”„ ì‹œì‘ì 
# - END: ê·¸ë˜í”„ ì¢…ë£Œì 

# -----------------------------------------------------------------------------
# ğŸ”— í”„ë¡œì íŠ¸ ë‚´ë¶€ ìœ í‹¸ë¦¬í‹° ì„í¬íŠ¸
# -----------------------------------------------------------------------------

from utils.llm_factory import get_embeddings, log_llm_error
# - get_embeddings: í…ìŠ¤íŠ¸ë¥¼ ë²¡í„°ë¡œ ë³€í™˜í•˜ëŠ” ì„ë² ë”© ëª¨ë¸
# - log_llm_error: LLM ì˜¤ë¥˜ ìƒì„¸ ë¡œê¹…

from utils.vector_store import VectorStoreManager
# Vector Store(ë²¡í„° DB) ê´€ë¦¬ í´ë˜ìŠ¤
# í…ìŠ¤íŠ¸ë¥¼ ë²¡í„°ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥í•˜ê³ , ìœ ì‚¬í•œ ë¬¸ì„œë¥¼ ê²€ìƒ‰


# =============================================================================
# ğŸ“‹ 1. State ì •ì˜
# =============================================================================
#
# RAG íŒŒì´í”„ë¼ì¸ì—ì„œ ë…¸ë“œë“¤ ì‚¬ì´ì— ì „ë‹¬ë˜ëŠ” ë°ì´í„° êµ¬ì¡°ì…ë‹ˆë‹¤.
# TypedDictë¥¼ ì‚¬ìš©í•˜ë©´ ë”•ì…”ë„ˆë¦¬ì— ì–´ë–¤ í‚¤ê°€ ìˆê³ , ê° í‚¤ì˜ ê°’ì€ ì–´ë–¤ íƒ€ì…ì¸ì§€ ëª…ì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
#
# ğŸ’¡ MessagesState vs TypedDict:
#    - MessagesState: ëŒ€í™” ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ë¥¼ ê´€ë¦¬ (Agent ì˜ˆì œì—ì„œ ì‚¬ìš©)
#    - TypedDict: ì»¤ìŠ¤í…€ í•„ë“œê°€ í•„ìš”í•  ë•Œ ì‚¬ìš© (RAGì—ì„œëŠ” documents, answer ë“±)
# =============================================================================

class RAGState(TypedDict):
    """
    RAG íŒŒì´í”„ë¼ì¸ì˜ ìƒíƒœ ì •ì˜
    
    ê° ë…¸ë“œëŠ” ì´ ìƒíƒœë¥¼ ì½ê³ , í•„ìš”í•œ í•„ë“œë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
    
    í•„ë“œ ì„¤ëª…:
    - question: ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì§ˆë¬¸ (ì…ë ¥)
    - documents: ê²€ìƒ‰ëœ ê´€ë ¨ ë¬¸ì„œ ë¦¬ìŠ¤íŠ¸ (ì¤‘ê°„ ê²°ê³¼)
    - answer: LLMì´ ìƒì„±í•œ ìµœì¢… ë‹µë³€ (ì¶œë ¥)
    """
    question: str                    # ì‚¬ìš©ì ì§ˆë¬¸ (Input)
    documents: List[Document]        # ê²€ìƒ‰ëœ ë¬¸ì„œë“¤ (Intermediate)
    answer: str                      # ìµœì¢… ë‹µë³€ (Output)


# =============================================================================
# ğŸ—„ï¸ 2. Vector Store ì´ˆê¸°í™” (ê³µí†µ ëª¨ë“ˆ ì‚¬ìš©)
# =============================================================================

from utils.data_loader import get_rag_vector_store

def get_naive_vs() -> VectorStoreManager:
    """Naive RAG ì „ìš© ì§€ì‹ ì°½ê³ ë¥¼ ë§Œë“¤ê³  ë°ì´í„°ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤."""
    return get_rag_vector_store(collection_name="naive_rag")


# =============================================================================
# ğŸ”§ 3. ë…¸ë“œ í•¨ìˆ˜ ì •ì˜
# =============================================================================
#
# ê° ë…¸ë“œ í•¨ìˆ˜ëŠ”:
# - ì…ë ¥: state (í˜„ì¬ ê·¸ë˜í”„ ìƒíƒœ)
# - ì¶œë ¥: dict (ì—…ë°ì´íŠ¸í•  í•„ë“œì™€ ê°’)
# =============================================================================

def retrieve(state: RAGState):
    """
    ë¬¸ì„œ ê²€ìƒ‰ ë…¸ë“œ: ì‚¬ìš©ì ì§ˆë¬¸ê³¼ ê´€ë ¨ëœ ë¬¸ì„œë¥¼ Vector Storeì—ì„œ ê²€ìƒ‰í•©ë‹ˆë‹¤.
    
    Args:
        state: í˜„ì¬ RAG ìƒíƒœ (question í•„ë“œ ì‚¬ìš©)
        
    Returns:
        dict: {"documents": ê²€ìƒ‰ëœ ë¬¸ì„œ ë¦¬ìŠ¤íŠ¸}
        
    ğŸ’¡ ë™ì‘ ì›ë¦¬:
       1. ì‚¬ìš©ì ì§ˆë¬¸ì„ ë²¡í„°ë¡œ ë³€í™˜
       2. Vector Storeì—ì„œ ê°€ì¥ ìœ ì‚¬í•œ ë²¡í„°ë¥¼ ê°€ì§„ ë¬¸ì„œë“¤ì„ ê²€ìƒ‰
       3. ìƒìœ„ kê°œì˜ ë¬¸ì„œë¥¼ ë°˜í™˜
    """
    print(f"ğŸ” ê²€ìƒ‰ ìˆ˜í–‰: {state['question']}")
    
    # Vector Store ê°€ì ¸ì˜¤ê¸°
    vs = get_naive_vs()
    
    # ìœ ì‚¬ë„ ê²€ìƒ‰ ìˆ˜í–‰ (ìƒìœ„ 2ê°œ ë¬¸ì„œ ê²€ìƒ‰)
    # k: ê²€ìƒ‰í•  ë¬¸ì„œ ê°œìˆ˜
    docs = vs.search(state["question"], k=2)
    
    # ê²€ìƒ‰ ê²°ê³¼ ë¡œê¹…
    print(f"   â†’ {len(docs)}ê°œ ë¬¸ì„œ ê²€ìƒ‰ë¨")
    for i, doc in enumerate(docs):
        print(f"   [{i+1}] {doc.page_content[:50]}...")
    
    # ìƒíƒœ ì—…ë°ì´íŠ¸: documents í•„ë“œì— ê²€ìƒ‰ëœ ë¬¸ì„œ ì €ì¥
    return {"documents": docs}


def generate(state: RAGState):
    """
    ë‹µë³€ ìƒì„± ë…¸ë“œ: ê²€ìƒ‰ëœ ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ì—¬ LLMì´ ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤.
    
    Args:
        state: í˜„ì¬ RAG ìƒíƒœ (question, documents í•„ë“œ ì‚¬ìš©)
        
    Returns:
        dict: {"answer": ìƒì„±ëœ ë‹µë³€}
        
    ğŸ’¡ í•µì‹¬ ê°œë…:
       - ê²€ìƒ‰ëœ ë¬¸ì„œë“¤ì„ "ì»¨í…ìŠ¤íŠ¸"ë¡œ LLMì—ê²Œ ì œê³µ
       - LLMì€ ìì‹ ì˜ ì§€ì‹ + ì»¨í…ìŠ¤íŠ¸ë¥¼ ì¡°í•©í•˜ì—¬ ë‹µë³€ ìƒì„±
       - ì´ë¥¼ í†µí•´ LLMì´ ëª¨ë¥´ëŠ” ì •ë³´ë„ ë‹µë³€ ê°€ëŠ¥
    """
    print("ğŸ“ ë‹µë³€ ìƒì„± ì¤‘...")
    
    # -------------------------------------------------------------------------
    # Step 1: ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±
    # -------------------------------------------------------------------------
    
    # ê²€ìƒ‰ëœ ë¬¸ì„œë“¤ì˜ ë‚´ìš©ì„ í•˜ë‚˜ì˜ ë¬¸ìì—´ë¡œ í•©ì¹¨
    # ê° ë¬¸ì„œëŠ” ë¹ˆ ì¤„ë¡œ êµ¬ë¶„
    context = "\n\n".join(doc.page_content for doc in state["documents"])
    
    # -------------------------------------------------------------------------
    # Step 2: í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ì •ì˜
    # -------------------------------------------------------------------------
    
    # {context}ì™€ {question}ì€ ë‚˜ì¤‘ì— ì‹¤ì œ ê°’ìœ¼ë¡œ ëŒ€ì²´ë¨
    template = """ë‹¤ìŒ ì»¨í…ìŠ¤íŠ¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì§ˆë¬¸ì— ë‹µë³€í•˜ì„¸ìš”.
    
    ì»¨í…ìŠ¤íŠ¸:
    {context}
    
    ì§ˆë¬¸: {question}
    """
    
    # í…œí”Œë¦¿ì„ ChatPromptTemplate ê°ì²´ë¡œ ë³€í™˜
    prompt = ChatPromptTemplate.from_template(template)
    
    # -------------------------------------------------------------------------
    # Step 3: ì²´ì¸ êµ¬ì„± ë° ì‹¤í–‰
    # -------------------------------------------------------------------------
    
    # LLM ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸°í™”
    model = ChatOpenAI(
        base_url=os.getenv("OPENAI_API_BASE"),
        api_key=os.getenv("OPENAI_API_KEY"),
        model=os.getenv("OPENAI_MODEL")
    )
    
    # ì²´ì¸ êµ¬ì„±: í”„ë¡¬í”„íŠ¸ â†’ LLM
    # LCEL (LangChain Expression Language) ë¬¸ë²•: | ë¡œ ì²´ì¸ ì—°ê²°
    chain = prompt | model
    
    # ì²´ì¸ ì‹¤í–‰: í…œí”Œë¦¿ì˜ ë³€ìˆ˜ë“¤ì— ì‹¤ì œ ê°’ì„ ë„£ì–´ì„œ LLM í˜¸ì¶œ
    response = chain.invoke({
        "context": context,
        "question": state["question"]
    })
    
    # ìƒíƒœ ì—…ë°ì´íŠ¸: answer í•„ë“œì— ìƒì„±ëœ ë‹µë³€ ì €ì¥
    return {"answer": response.content}


# =============================================================================
# ğŸ”€ 4. ê·¸ë˜í”„ êµ¬ì„±
# =============================================================================

def create_graph():
    """
    Naive RAG ê·¸ë˜í”„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    
    ê·¸ë˜í”„ êµ¬ì¡°:
        START â†’ retrieve â†’ generate â†’ END
        
    Returns:
        CompiledGraph: ì‹¤í–‰ ê°€ëŠ¥í•œ ì»´íŒŒì¼ëœ ê·¸ë˜í”„
        
    ğŸ’¡ ì´ ê·¸ë˜í”„ëŠ” ì„ í˜• êµ¬ì¡°ì…ë‹ˆë‹¤ (ë¶„ê¸°/ë£¨í”„ ì—†ìŒ)
       ë” ë³µì¡í•œ íŒ¨í„´ì€ 03, 04 ì˜ˆì œì—ì„œ ë‹¤ë£¹ë‹ˆë‹¤.
    """
    # ê·¸ë˜í”„ ë¹Œë” ìƒì„± (RAGStateë¥¼ ìƒíƒœ íƒ€ì…ìœ¼ë¡œ ì‚¬ìš©)
    builder = StateGraph(RAGState)
    
    # -------------------------------------------------------------------------
    # ë…¸ë“œ ì¶”ê°€
    # -------------------------------------------------------------------------
    
    # retrieve ë…¸ë“œ: ë¬¸ì„œ ê²€ìƒ‰ ë‹´ë‹¹
    builder.add_node("retrieve", retrieve)
    
    # generate ë…¸ë“œ: ë‹µë³€ ìƒì„± ë‹´ë‹¹
    builder.add_node("generate", generate)
    
    # -------------------------------------------------------------------------
    # ì—£ì§€ ì—°ê²° (ì„ í˜• êµ¬ì¡°: ìˆœì„œëŒ€ë¡œ ì‹¤í–‰)
    # -------------------------------------------------------------------------
    
    # START â†’ retrieve: ì‹œì‘í•˜ë©´ ë¨¼ì € ê²€ìƒ‰
    builder.add_edge(START, "retrieve")
    
    # retrieve â†’ generate: ê²€ìƒ‰ í›„ ë‹µë³€ ìƒì„±
    builder.add_edge("retrieve", "generate")
    
    # generate â†’ END: ë‹µë³€ ìƒì„± í›„ ì¢…ë£Œ
    builder.add_edge("generate", END)
    
    # ê·¸ë˜í”„ ì»´íŒŒì¼ í›„ ë°˜í™˜
    return builder.compile()


# =============================================================================
# â–¶ï¸ 5. ì‹¤í–‰ í•¨ìˆ˜
# =============================================================================

def run_rag(question: str):
    """
    RAG íŒŒì´í”„ë¼ì¸ì„ ì‹¤í–‰í•˜ì—¬ ì§ˆë¬¸ì— ë‹µë³€í•©ë‹ˆë‹¤.
    
    Args:
        question: ì‚¬ìš©ìì˜ ì§ˆë¬¸ ë¬¸ìì—´
    """
    # ê·¸ë˜í”„ ìƒì„±
    app = create_graph()
    
    print(f"\n{'='*60}")
    print(f"ğŸ¤– ì§ˆë¬¸: {question}")
    print('='*60)
    
    try:
        # ê·¸ë˜í”„ ì‹¤í–‰ (ì´ˆê¸° ìƒíƒœ: ì§ˆë¬¸ë§Œ ì„¤ì •)
        result = app.invoke({"question": question})
        
        # ê²°ê³¼ ì¶œë ¥
        print(f"\nğŸ¤– ë‹µë³€: {result['answer']}")
        
    except Exception as e:
        # ì˜¤ë¥˜ ìƒì„¸ ë¡œê¹…
        log_llm_error(e)
        print("âŒ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")


# =============================================================================
# ğŸš€ 6. ë©”ì¸ ì‹¤í–‰ë¶€ (CLI ì¸í„°í˜ì´ìŠ¤)
# =============================================================================

if __name__ == "__main__":
    # í”„ë¡œê·¸ë¨ ì‹œì‘ ë©”ì‹œì§€
    print("\n" + "="*60)
    print("ğŸ“š LangGraph Naive RAG Example")
    print("="*60)
    print("CLI ëª¨ë“œë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤. ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.")
    print("ì¢…ë£Œí•˜ë ¤ë©´ 'quit', 'exit', ë˜ëŠ” 'q'ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n")
    
    # ë¬´í•œ ë£¨í”„: ì‚¬ìš©ìê°€ ì¢…ë£Œí•  ë•Œê¹Œì§€ ì§ˆë¬¸-ë‹µë³€ ë°˜ë³µ
    while True:
        try:
            # ì‚¬ìš©ì ì…ë ¥ ë°›ê¸°
            question = input("ğŸ§‘ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”: ").strip()
            
            # ë¹ˆ ì…ë ¥ ë¬´ì‹œ
            if not question:
                continue
            
            # ì¢…ë£Œ ëª…ë ¹ì–´ í™•ì¸
            if question.lower() in ("quit", "exit", "q"):
                print("ğŸ‘‹ RAG Agentë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤. ì•ˆë…•íˆ ê°€ì„¸ìš”!")
                break
            
            # RAG ì‹¤í–‰
            run_rag(question)
            
        except KeyboardInterrupt:
            print("\nğŸ‘‹ RAG Agentë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤. (Ctrl+C)")
            break
        except EOFError:
            print("\nğŸ‘‹ RAG Agentë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤. (EOF)")
            break
